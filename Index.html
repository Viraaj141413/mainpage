"use client";
import React from "react";

import { useHandleStreamResponse } from "../utilities/runtime-helpers";

function MainComponent() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const [streamingMessage, setStreamingMessage] = useState("");
  const [showImageModal, setShowImageModal] = useState(false);
  const [imagePrompt, setImagePrompt] = useState("");
  const [generatingImage, setGeneratingImage] = useState(false);
  const [generatedImage, setGeneratedImage] = useState(null);
  const chatContainerRef = useRef(null);
  const { data: session } = useUser();
  const [error, setError] = useState(null);

  useEffect(() => {
    const loadChatHistory = async () => {
      if (session?.user?.id) {
        try {
          const response = await fetch(
            `/api/chat-history?userId=${session.user.id}`
          );
          if (response.ok) {
            const history = await response.json();
            setMessages(history.chats || []);
          }
        } catch (err) {
          console.error("Error loading chat history:", err);
          setError("Failed to load chat history");
        }
      }
    };
    loadChatHistory();
  }, [session]);

  const handleStreamResponse = useHandleStreamResponse({
    onChunk: setStreamingMessage,
    onFinish: async (message) => {
      const newMessage = { role: "assistant", content: message };
      setMessages((prev) => [...prev, newMessage]);
      setStreamingMessage("");

      if (session?.user?.id) {
        try {
          await fetch("/api/chat-history", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userId: session.user.id,
              message: input,
              response: message,
              type: "chat",
            }),
          });
        } catch (err) {
          console.error("Error saving chat:", err);
        }
      }
    },
  });

  const handleSendMessage = async () => {
    if (!input.trim()) return;

    const userMessage = { role: "user", content: input };
    setMessages((prev) => [...prev, userMessage]);
    setInput("");

    try {
      const response = await fetch("/integrations/chat-gpt/conversationgpt4", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [...messages, userMessage],
          stream: true,
        }),
      });
      handleStreamResponse(response);
    } catch (err) {
      console.error("Error sending message:", err);
      setError("Failed to send message");
    }
  };

  const handleGenerateImage = async () => {
    if (!imagePrompt.trim()) return;

    setGeneratingImage(true);
    try {
      const response = await fetch(
        `/integrations/stable-diffusion-v-3/?prompt=${encodeURIComponent(
          imagePrompt
        )}`
      );
      if (!response.ok) {
        throw new Error("Failed to generate image");
      }
      const data = await response.json();
      setGeneratedImage(data.data[0]);
    } catch (err) {
      console.error("Error generating image:", err);
      setError("Failed to generate image");
    } finally {
      setGeneratingImage(false);
    }
  };

  useEffect(() => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTop =
        chatContainerRef.current.scrollHeight;
    }
  }, [messages, streamingMessage]);

  return (
    <div className="relative h-screen bg-[#13111C] overflow-hidden">
      {/* Background Effect */}
      <div className="absolute inset-0 z-0">
        {/* Violet gradient orbs */}
        <div className="absolute top-[-20%] left-[-10%] w-[40%] h-[40%] bg-[#8B5CF6] rounded-full filter blur-[120px] opacity-20"></div>
        <div className="absolute bottom-[-10%] right-[-5%] w-[35%] h-[35%] bg-[#6D28D9] rounded-full filter blur-[120px] opacity-15"></div>
        {/* White accent */}
        <div className="absolute top-[30%] right-[20%] w-[25%] h-[25%] bg-white rounded-full filter blur-[100px] opacity-[0.08]"></div>
        {/* Subtle grid pattern */}
        <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAxMCAwIEwgMCAwIDAgMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMiIgc3Ryb2tlLXdpZHRoPSIwLjUiLz48L3BhdGggZD0iTSAxMCAwIEwgMCAwIDAgMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMiIgc3Ryb2tlLXdpZHRoPSIwLjUiLz48L3BhdGggZD0iTSAxMCAwIEwgMCAwIDAgMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMiIgc3Ryb2tlLXdpZHRoPSIwLjUiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=')] opacity-[0.03]"></div>
      </div>

      {/* Main Chat Area */}
      <div className="relative flex flex-col h-full z-10">
        {/* Top Bar */}
        <div className="bg-white/[0.02] backdrop-blur-xl p-4 flex justify-between items-center border-b border-white/[0.05]">
          <div className="flex gap-2">
            <button
              onClick={() => {
                setMessages([]);
                setInput("");
                setStreamingMessage("");
              }}
              className="px-6 py-2 rounded-lg bg-white/[0.05] text-white/90 font-medium hover:bg-white/[0.08] transition-all duration-300 flex items-center gap-2 backdrop-blur-md"
            >
              <i className="fas fa-plus opacity-50"></i>
              New Chat
            </button>
            <button
              onClick={() => setShowImageModal(true)}
              className="px-6 py-2 rounded-lg bg-white/[0.05] text-white/90 font-medium hover:bg-white/[0.08] transition-all duration-300 backdrop-blur-md"
            >
              <i className="fas fa-image mr-2 opacity-50"></i>
              Create
            </button>
          </div>
          <div className="text-white/50 font-medium flex items-center gap-2">
            <i className="fas fa-robot"></i>
            AI Assistant
          </div>
        </div>

        {/* Messages Area */}
        <div
          ref={chatContainerRef}
          className="flex-1 overflow-y-auto p-6 space-y-6"
        >
          {messages.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-full text-center">
              <div className="w-20 h-20 bg-white/[0.03] rounded-full flex items-center justify-center mb-6 backdrop-blur-lg">
                <i className="fas fa-comments text-3xl text-white/30"></i>
              </div>
              <h2 className="text-3xl font-light text-white/90 mb-3">
                How can I help you today?
              </h2>
              <p className="text-white/50 max-w-md text-lg">
                Start a conversation or create a image by pressing "create" at
                the top!
              </p>
            </div>
          ) : (
            <>
              {messages.map((msg, idx) => (
                <div
                  key={idx}
                  className={`flex ${
                    msg.role === "user" ? "justify-end" : "justify-start"
                  } animate-fadeIn`}
                >
                  <div
                    className={`flex items-start gap-4 max-w-[70%] ${
                      msg.role === "user" ? "flex-row-reverse" : ""
                    }`}
                  >
                    <div
                      className={`w-8 h-8 rounded-full flex items-center justify-center ${
                        msg.role === "user"
                          ? "bg-white/[0.05]"
                          : "bg-white/[0.03]"
                      } backdrop-blur-md`}
                    >
                      {msg.role === "user" ? (
                        <i className="fas fa-user text-white/30 text-sm"></i>
                      ) : (
                        <i className="fas fa-robot text-white/30 text-sm"></i>
                      )}
                    </div>
                    <div
                      className={`p-4 rounded-2xl ${
                        msg.role === "user"
                          ? "bg-white/[0.05] text-white/90"
                          : "bg-white/[0.03] text-white/90"
                      } backdrop-blur-md`}
                    >
                      <p className="text-[15px] leading-relaxed whitespace-pre-wrap">
                        {msg.content}
                      </p>
                    </div>
                  </div>
                </div>
              ))}
              {streamingMessage && (
                <div className="flex justify-start animate-fadeIn">
                  <div className="flex items-start gap-4 max-w-[70%]">
                    <div className="w-8 h-8 rounded-full bg-white/[0.03] flex items-center justify-center backdrop-blur-md">
                      <i className="fas fa-robot text-white/30 text-sm"></i>
                    </div>
                    <div className="p-4 rounded-2xl bg-white/[0.03] text-white/90 backdrop-blur-md">
                      <p className="text-[15px] leading-relaxed whitespace-pre-wrap">
                        {streamingMessage}
                        <span className="typing-animation">...</span>
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </>
          )}
        </div>

        {/* Input Area */}
        <div className="p-6 border-t border-white/[0.05] bg-white/[0.02] backdrop-blur-xl">
          <div className="relative max-w-4xl mx-auto">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={(e) => e.key === "Enter" && handleSendMessage()}
              placeholder="Type your message..."
              className="w-full bg-white/[0.05] text-white/90 rounded-xl pl-5 pr-12 py-4 focus:outline-none focus:ring-1 focus:ring-white/[0.1] text-[15px] placeholder-white/30 backdrop-blur-md"
            />
            <button
              onClick={handleSendMessage}
              disabled={!input.trim()}
              className="absolute right-4 top-1/2 transform -translate-y-1/2 text-white/50 hover:text-white/90 transition-colors duration-200 disabled:opacity-30 disabled:cursor-not-allowed"
            >
              <i className="fas fa-paper-plane text-lg"></i>
            </button>
          </div>
        </div>

        {/* Image Modal */}
        {showImageModal && (
          <div className="fixed inset-0 bg-black/30 backdrop-blur-md flex items-center justify-center z-50">
            <div className="bg-[#13111C]/90 p-6 rounded-xl w-[90%] max-w-[600px] shadow-2xl border border-white/[0.05] backdrop-blur-xl">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-white/90 text-xl font-light">
                  Create Image
                </h2>
                <button
                  onClick={() => {
                    setShowImageModal(false);
                    setGeneratedImage(null);
                    setImagePrompt("");
                  }}
                  className="text-white/50 hover:text-white/90 transition-colors duration-200"
                >
                  <i className="fas fa-times"></i>
                </button>
              </div>

              <div className="space-y-4">
                <textarea
                  value={imagePrompt}
                  onChange={(e) => setImagePrompt(e.target.value)}
                  placeholder="Describe what you want to create as a image.."
                  className="w-full bg-white/[0.05] text-white/90 rounded-xl p-4 focus:outline-none focus:ring-1 focus:ring-white/[0.1] text-[15px] placeholder-white/30 min-h-[100px] backdrop-blur-md"
                />

                <button
                  onClick={handleGenerateImage}
                  disabled={generatingImage || !imagePrompt.trim()}
                  className="w-full bg-white/[0.05] text-white/90 py-3 rounded-xl font-medium hover:bg-white/[0.08] transition-all duration-300 disabled:opacity-30 disabled:cursor-not-allowed flex items-center justify-center gap-2 backdrop-blur-md"
                >
                  {generatingImage ? (
                    <>
                      <i className="fas fa-spinner fa-spin"></i>
                      Creating...
                    </>
                  ) : (
                    <>
                      <i className="fas fa-wand-magic-sparkles"></i>
                      Create Image
                    </>
                  )}
                </button>

                {generatedImage && (
                  <div className="mt-4 animate-fadeIn">
                    <img
                      src={generatedImage}
                      alt="Generated"
                      className="w-full rounded-xl shadow-lg"
                    />
                  </div>
                )}

                {error && (
                  <div className="text-red-400/90 text-sm mt-2 flex items-center gap-2 bg-red-500/10 p-3 rounded-lg backdrop-blur-md">
                    <i className="fas fa-exclamation-circle"></i>
                    {error}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>

      <style jsx global>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes typing {
          0% { opacity: 0.2; }
          20% { opacity: 1; }
          100% { opacity: 0.2; }
        }

        .typing-animation::after {
          content: '...';
          animation: typing 1.4s infinite;
        }

        /* Hide scrollbar but keep functionality */
        ::-webkit-scrollbar {
          width: 0px;
          background: transparent;
        }
      `}</style>
    </div>
  );
}

export default MainComponent;
